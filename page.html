<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Chat me</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<style>
		html, body {
			height: 100%;
			margin: 0px;
			padding: 0px;
			font-size: 14px;
		}
		*{
			font-family: Verdana, sans-serif;
		}
		#controlPanel {
			background-color: #d4a373;
			height: 100%;
			width: 30%;
			float: left;
			line-height: 2;
		}

		#display {
			padding-top: 10px;
			padding-left: 10px;
			height: 100%;
			background-color: #faedcd;
			line-height: 1;
			overflow: scroll;
		}
		.panelTitle {
			padding: 0;
			margin: 0;
			color: #000000;
			text-align: center;
		}


		#checkMessagesPanel, #newUserPanel, #newMessagePanel{
			border: 1px solid black;
			position: relative;
			padding: 3px;
		}
		textarea{
			width: 98%;
		}
		input[type=text] {
			width: 125px;
			position: absolute;
			right: 0px;
		}
		input[type=password] {
			width: 125px;
			position: absolute;
			right: 0px;
		}
		#responseTextHere{
			font-size: 24px;
			text-align: center;
		}
		#displayMessagesHeader{
			font-size: 36px;
			position: relative;
			left: 10px;
		}
		#displayMessagesHeader > span{
			position: absolute;
			font-size: 24px;
			left: 10px;
		}
		.messageElement{
			border: 0.5mm ridge rgba(211, 220, 50, .6);
  			width: fit-content;
			height: fit-content;
			background-color: #e9edc9;
			font-size: 20px;
			line-height: 1.5;
		}
		.userElement{
			border: 0.5mm ridge rgba(211, 220, 50, .6);
  			width: fit-content;
			height: fit-content;
			background-color: #e9edc9;
			font-size: 20px;
			line-height: 1.5;
		}

		#suButton{
			position: absolute;
			left: 10px;
		}
		#sessionInfo{
			position: absolute;
			bottom: 1em;
			padding: 5px;
			margin-left: 2.5%;
			margin-right: 2.5%;
			width: 25%;
			border-radius: 25px;
			height: fit-content;
			text-align: center;
			background-color: #faedcd;
		}

	</style>

</head>






<body>

	<div id="controlPanel">

		<div id="checkMessagesPanel">
				<button onClick="checkMessagesTo()">Check Your Messages</button>
				<button onClick="checkMessagesFrom()">Check Messages You Have Sent</button>
		</div>

		<div id="newMessagePanel">
			<p class="panelTitle"><b>Send a Message</b></p>

				To: <input autocomplete="off" type="text" id="newMessageTo" placeholder="user1, user2, user3"></input><br>
				Message:<br>
				<textarea rows=6 cols=30 id="newMessageMessage"></textarea><br>
				<button onClick="createMessage()">Submit Message</button>

		</div>

		<div id="newUserPanel">
			<p class="panelTitle"><b>Log In/Sign up</b></p>

				<span id="username">Username: </span><input autocomplete="off" type="text" id="createUserUsername"></input><br>
				<span id="password">Password: </span><input autocomplete="off" type="password" id="createUserPassword"></input><br>
				<button onClick="logIn()">Log in</button> <button onClick="createUser()">Create New User</button>

		</div>
		<br>
		<button type="button" id="suButton">Show all users</button> <br> <br>

		<div id="sessionInfo">
			You are not logged in!
		</div>

	</div>

	<div id="display">

		<div id="responseTextHere"><div id="displayMessagesHeader">Start by creating a user or clicking the <i>Show all users</i> button.</div></div>
	</div>








	<script src="/socket.io/socket.io.js"></script>
	<script>

	var socket = io();

	var loggedIn = false;
	var sessionUsername = "";

	socket.on('listAllUsers',function(response){
		var responseText = "<div id='displayMessagesHeader'>Here are all of the users in the database:<br><span>Click on a user to automatically put them in the \"To\" field.</span></div><br><br>";
		for(var i=0; i<response.length; i++){
			responseText+= "<div class='userElement' onclick='changeTo(\"" + response[i]["username"]+"\")'> ➼ " + response[i]["username"] + "</div><br>";
		}
		responseTextHere.innerHTML = responseText;
	});
	socket.on('userAlreadyExists',function(username){
		responseTextHere.innerHTML = "The user <i>"+username+"</i> already exists. If that is you, log in with your password. Otherwise, try another username.";
	});
	socket.on('createUser',function(response){
		responseTextHere.innerHTML = response["response"];
		sessionUsername = response["username"];
		loggedIn = true;
		sessionInfo.innerHTML = "You are signed in as <i>"+sessionUsername+"</i>.";
	});
	socket.on('logIn',function(response){
		responseTextHere.innerHTML = response["response"];
		sessionUsername = response["username"];
		loggedIn = true;
		sessionInfo.innerHTML = "You are signed in as <i>"+sessionUsername+"</i>.";
	});
	socket.on('incorrectPassword',function(response){
		responseTextHere.innerHTML = "Password for user <i>"+response["username"]+"</i> does not match database. Try another password.";
	});
	socket.on('createMessage',function(response){
		responseTextHere.innerHTML = response["response"];
	});
	socket.on('userDNE',function(response){
		responseTextHere.innerHTML = "User <i>"+response+"</i> does not exist.";
	});
	socket.on('noMessages',function(response){
		if(response["type"] == "from"){
			responseTextHere.innerHTML = "User <i>" + response["username"]+"</i> has not sent any messages!";
		} else if(response["type"] == "to"){
			responseTextHere.innerHTML = "User <i>" + response["username"]+"</i> has not received any messages!";
		}
	});
	socket.on('checkMessagesFrom',function(response){
		var responseText = "<div id='displayMessagesHeader'>Here are the messages that you have sent, <i>" + response[0]["from"] +"</i>:</div><br>";
		for(let i=response.length-1; i>=0; i--){
			responseText += "<div class=\"messageElement\"><strong> ➼ To "+response[i]["to"]+":</strong> "+response[i]["body"]+"</div><br>";
		}
		responseTextHere.innerHTML = responseText;
	});
	socket.on('checkMessagesTo',function(response){
		var responseText = "<div id='displayMessagesHeader'>Here are your messages, <i>" + response[0]["to"] +"</i>:</div><br>";
		for(let i=response.length-1; i>=0; i--){
			responseText += "<div class=\"messageElement\"><strong> ➼ From "+response[i]["from"]+":</strong> "+response[i]["body"]+"</div><br>";
		}
		responseTextHere.innerHTML = responseText;
	});

	function updateSession(){

	}



	$(document).ready(function(){
		let display = document.getElementById('display');

		$("#suButton").click(function(){
			socket.emit('listAllUsers');
		});

		$('input, textarea, select')
                .not(':input[type=button], :input[type=submit], :input[type=reset]').focus(function(){
			$(this).css("background-color","#cccccc");
		});
		$('input, textarea, select')
                .not(':input[type=button], :input[type=submit], :input[type=reset]').blur(function(){
			$(this).css("background-color","#ffffff");
		});
	});



		function checkMessagesTo() {
			if(loggedIn){
				socket.emit('checkMessagesTo',{"username":sessionUsername});
			} else {
				responseTextHere.innerHTML = "You aren't logged in yet. Try creating a user first!";
			}
		}

		function checkMessagesFrom() {
			if(loggedIn){
				socket.emit('checkMessagesFrom',{"username":sessionUsername});
			} else {
				responseTextHere.innerHTML = "You aren't logged in yet. Try creating a user first!";
			}

		}

		function createMessage(){
			if(loggedIn){
				var to = document.getElementById("newMessageTo").value;
				var message = document.getElementById("newMessageMessage").value;
				if(message=="") document.getElementById("responseTextHere").innerHTML = "Oops! Your message is empty.";
				else if(to=="") document.getElementById("responseTextHere").innerHTML =
				"Make sure you enter who the message is to!";
				else {
					socket.emit('createMessage',{"from":sessionUsername,"to":to,"body":message});
					document.getElementById("newMessageTo").value = "";
					document.getElementById("newMessageMessage").value = "";
				}
			} else {
				responseTextHere.innerHTML = "You aren't logged in yet. Try creating a user first!";
			}

		}

		function createUser(){
			var username = document.getElementById("createUserUsername").value;
			var password = document.getElementById("createUserPassword").value;
			if(username=="") document.getElementById("responseTextHere").innerHTML = "Make sure you enter a username.";
			else if(password=="") document.getElementById("responseTextHere").innerHTML = "Make sure you enter a password.";
			else{
				socket.emit('createUser',{"username":username,"password":password});
				document.getElementById("createUserUsername").value = "";
				document.getElementById("createUserPassword").value = "";
			}
		}
		function logIn(){
			var username = document.getElementById("createUserUsername").value;
			var password = document.getElementById("createUserPassword").value;
			if(username=="") document.getElementById("responseTextHere").innerHTML = "Make sure you enter a username.";
			else if(password=="") document.getElementById("responseTextHere").innerHTML = "Make sure you enter a password.";
			else{
				socket.emit('logIn',{"username":username,"password":password});
				document.getElementById("createUserUsername").value = "";
				document.getElementById("createUserPassword").value = "";
			}
		}

		function changeTo(user){
			document.getElementById("newMessageTo").value = user;
		}

	</script>

</body>
</html>
